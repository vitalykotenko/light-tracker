<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Облік світла</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui;
      background: #000;
      color: #fff;
    }

    .hidden { display: none; }

    /* ===== TOP BAR ===== */
    .top-actions {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid #1c1c1e;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      background: #1c1c1e;
      color: #0a84ff;
      font-size: 14px;
    }

    .btn:active { background: #2c2c2e; }

    .container {
      padding: 16px;
    }

    /* ===== LIST ===== */
    .list-item {
      padding: 14px;
      border-radius: 12px;
      background: #1c1c1e;
      margin-bottom: 8px;
      font-size: 17px;
    }

    .list-item:active {
      background: #2c2c2e;
    }

    /* ===== MONTH GRID ===== */
    .month-title {
      font-size: 22px;
      margin-bottom: 12px;
    }

    .grid-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day {
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      background: #1c1c1e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    .day.filled {
      background: #1c2a3a;
    }

    .day:active {
      background: #2c2c2e;
    }

    /* ===== DAY VIEW ===== */
    .top-bar {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .back {
      font-size: 17px;
      color: #0a84ff;
      margin-right: 12px;
    }

    .date-title {
      font-size: 15px;
      color: #aaa;
    }

    .grid-hours {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    .hour {
      aspect-ratio: 1 / 1;
      border-radius: 14px;
      background: #1c1c1e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #aaa;
    }

    .hour.red { background: #b3261e; color: #fff; }
    .hour.green { background: #1fa14a; color: #fff; }

    input[type="file"] { display: none; }
  </style>
</head>
<body>

<!-- ===== GLOBAL ACTIONS ===== -->
<div class="top-actions">
  <div class="btn" id="exportBtn">Експорт CSV</div>
  <div class="btn" id="importBtn">Імпорт CSV</div>
  <input type="file" id="fileInput" accept=".csv">
</div>

<!-- ===== YEARS ===== -->
<div id="yearsView" class="container hidden"></div>

<!-- ===== MONTHS LIST ===== -->
<div id="monthsListView" class="container hidden"></div>

<!-- ===== MONTH ===== -->
<div id="monthView" class="container hidden"></div>

<!-- ===== DAY ===== -->
<div id="dayView" class="container hidden">
  <div class="top-bar">
    <div class="back" id="backBtn">← Назад</div>
    <div class="date-title" id="dateTitle"></div>
  </div>
  <div class="grid-hours" id="hoursGrid"></div>
</div>

<script>
/* ===== CONFIG ===== */
const YEARS = [2026, 2027];
const MONTHS = [
  "Січень","Лютий","Березень","Квітень","Травень","Червень",
  "Липень","Серпень","Вересень","Жовтень","Листопад","Грудень"
];

/* ===== STATE ===== */
let navStack = [];
let currentYear, currentMonth, currentDay;

/* ===== ELEMENTS ===== */
const yearsView = document.getElementById("yearsView");
const monthsListView = document.getElementById("monthsListView");
const monthView = document.getElementById("monthView");
const dayView = document.getElementById("dayView");
const backBtn = document.getElementById("backBtn");
const hoursGrid = document.getElementById("hoursGrid");
const dateTitle = document.getElementById("dateTitle");

const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const fileInput = document.getElementById("fileInput");

/* ===== NAV ===== */
function show(view) {
  [yearsView, monthsListView, monthView, dayView].forEach(v => v.classList.add("hidden"));
  view.classList.remove("hidden");
}

function push(view) {
  navStack.push(view);
  show(view);
}

function back() {
  navStack.pop();
  show(navStack[navStack.length - 1]);
}

/* ===== YEARS ===== */
function renderYears() {
  yearsView.innerHTML = "";
  YEARS.forEach(y => {
    const d = document.createElement("div");
    d.className = "list-item";
    d.textContent = y;
    d.onclick = () => {
      currentYear = y;
      renderMonthsList();
      push(monthsListView);
    };
    yearsView.appendChild(d);
  });
}

/* ===== MONTHS LIST ===== */
function renderMonthsList() {
  monthsListView.innerHTML = "";
  MONTHS.forEach((m, i) => {
    const d = document.createElement("div");
    d.className = "list-item";
    d.textContent = m;
    d.onclick = () => {
      currentMonth = i;
      renderMonth();
      push(monthView);
    };
    monthsListView.appendChild(d);
  });
}

/* ===== MONTH GRID ===== */
function renderMonth() {
  monthView.innerHTML = "";

  const title = document.createElement("div");
  title.className = "month-title";
  title.textContent = `${MONTHS[currentMonth]} ${currentYear}`;

  const grid = document.createElement("div");
  grid.className = "grid-calendar";

  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const saved = JSON.parse(localStorage.getItem(key)) || [];

    const day = document.createElement("div");
    day.className = "day";
    day.textContent = d;
    if (saved.some(v => v > 0)) day.classList.add("filled");

    day.onclick = () => {
      currentDay = d;
      renderDay();
      push(dayView);
    };

    grid.appendChild(day);
  }

  monthView.appendChild(title);
  monthView.appendChild(grid);
}

/* ===== DAY ===== */
function renderDay() {
  hoursGrid.innerHTML = "";
  const key = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(currentDay).padStart(2,"0")}`;
  dateTitle.textContent = `${currentDay} ${MONTHS[currentMonth].toLowerCase()} ${currentYear}`;

  const data = JSON.parse(localStorage.getItem(key)) || Array(24).fill(0);

  for (let i = 0; i < 24; i++) {
    const h = document.createElement("div");
    h.className = "hour";
    h.textContent = `${String(i).padStart(2,"0")}–${String(i+1).padStart(2,"0")}`;

    if (data[i] === 1) h.classList.add("red");
    if (data[i] === 2) h.classList.add("green");

    h.onclick = () => {
      data[i] = (data[i] + 1) % 3;
      localStorage.setItem(key, JSON.stringify(data));
      h.className = "hour";
      if (data[i] === 1) h.classList.add("red");
      if (data[i] === 2) h.classList.add("green");
    };

    hoursGrid.appendChild(h);
  }
}

/* ===== BACK ===== */
backBtn.onclick = back;

/* ===== EXPORT / IMPORT ===== */
exportBtn.onclick = () => {
  let csv = "date," + Array.from({length:24},(_,i)=>`h${String(i).padStart(2,"0")}`).join(",") + "\n";
  Object.keys(localStorage).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k)).sort()
    .forEach(k => csv += k + "," + JSON.parse(localStorage.getItem(k)).join(",") + "\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "light-data.csv";
  a.click();
};

importBtn.onclick = () => fileInput.click();
fileInput.onchange = e => {
  const reader = new FileReader();
  reader.onload = () => {
    reader.result.split("\n").slice(1).forEach(line => {
      if (!line.trim()) return;
      const [date, ...vals] = line.split(",");
      localStorage.setItem(date, JSON.stringify(vals.map(Number)));
    });
    renderMonth();
    alert("Дані імпортовано");
  };
  reader.readAsText(e.target.files[0]);
};

/* ===== START ===== */
(function start() {
  const now = new Date();
  currentYear = YEARS.includes(now.getFullYear()) ? now.getFullYear() : YEARS[0];
  currentMonth = now.getMonth();

  renderYears();
  renderMonthsList();
  renderMonth();

  navStack = [];
  push(monthView);
})();
</script>

</body>
</html>
